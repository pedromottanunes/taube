<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerar Orçamento • OD Drive</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --od-primary: #0f766e; /* teal-700 */
    }
    .focus\:ring-primary:focus {
      --tw-ring-color: var(--od-primary);
      --tw-ring-opacity: 0.6;
    }
    .bg-primary {
      background-color: var(--od-primary);
    }
    .text-primary {
      color: var(--od-primary);
    }
    .border-primary {
      border-color: var(--od-primary);
    }
  </style>

  <script src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>

</head>
<body class="min-h-screen flex items-center justify-center bg-gray-100 px-2">
  <section class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 sm:p-8">
    <h1 class="text-2xl sm:text-3xl font-semibold text-center text-gray-800 mb-6 sm:mb-8">
      Gerar Orçamento – OD Drive
    </h1>
    <form id="odForm" class="space-y-4 sm:space-y-5">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- Empresa -->
        <div class="sm:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="company_name">Empresa</label>
          <input id="company_name" name="company_name" type="text" required placeholder="Ex.: Acme Corp"
            class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" />
        </div>
        <!-- Site -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="site_url">Site</label>
          <input id="site_url" name="site_url" type="url" required placeholder="https://exemplo.com"
            class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" />
        </div>
        <!-- Cidade -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="city">Cidade</label>
          <input id="city" name="city" type="text" required placeholder="São Paulo"
            class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" />
        </div>
        <!-- Objetivo -->
        <div class="sm:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="objective">Objetivo</label>
          <input id="objective" name="objective" type="text" required placeholder="Divulgar nova linha de produtos"
            class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" />
        </div>

<!-- Upload da Imagem -->
<div class="sm:col-span-2">
  <label class="block text-sm font-medium text-gray-700 mb-1" for="mockup_image">Imagem / Mockup (PNG ou JPG)</label>
  <input id="mockup_image" name="mockup_image" type="file" accept="image/png, image/jpeg"
    class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary bg-white" />
</div>
        
      </div>


      
      <!-- Quantidade de Carros & Desconto -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="cars_qtd">Qtd. Carros</label>
          <input id="cars_qtd" name="cars_qtd" type="number" min="1" required placeholder="10"
            class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="discount">Desconto (R$)</label>
          <input id="discount" name="discount" type="number" step="0.01" value="0"
            class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" />
        </div>
      </div>
      <!-- Submit -->
      <button type="submit"
        class="w-full py-3 bg-primary text-white font-semibold rounded-lg hover:opacity-90 transition-all shadow-sm mt-2">
        Gerar Orçamento
      </button>
      <p id="msg" class="text-center text-sm mt-2 hidden"></p>
    </form>
  </section>
  <script>
    
    const form = document.getElementById('odForm');
    const msg = document.getElementById('msg');
    const inputImagem = document.getElementById('mockup_image');


let accessToken = '';
let tokenClient = null;

const CLIENT_ID = '206253858878-rdmme43csja9vuicd6uh4so1cgfg3v0u.apps.googleusercontent.com';
const API_KEY = 'AIzaSyDSQt5SOwfXOKuMasPUShacyHmsjzObDnA';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

function tokenAindaValido() {
  const exp = Number(localStorage.getItem('google_token_exp')) || 0;
  return accessToken && Date.now() < exp;
}

function initGoogle(cb) {
  if (tokenClient) { cb && cb(); return; }

  gapi.load('client', async () => {
    await gapi.client.init({ apiKey: API_KEY });
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: handleTokenResponse
    });
    cb && cb();
  });
}

function handleTokenResponse(resp) {
  if (resp && resp.access_token) {
    accessToken = resp.access_token;
    localStorage.setItem('google_access_token', accessToken);
    const exp = Date.now() + ((resp.expires_in ?? 3600) - 300) * 1000;
    localStorage.setItem('google_token_exp', exp);
  }
}

function ensureAccessToken(callback) {
  if (tokenAindaValido()) {
    callback();
    return;
  }

  initGoogle(() => {
    tokenClient.callback = (resp) => {
      if (resp && resp.access_token) {
        handleTokenResponse(resp);
        callback();
      } else {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      }
    };
    tokenClient.requestAccessToken({ prompt: '' });
  });
}

    

  form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.classList.add('hidden');

  const file = inputImagem.files[0];
  if (!file || !(file.type === "image/png" || file.type === "image/jpeg")) {
    msg.textContent = '❌ Selecione uma imagem PNG ou JPG.';
    msg.className = 'text-center text-sm mt-2 text-red-600';
    msg.classList.remove('hidden');
    return;
  }

  // Autenticação do Google
  await ensureAccessToken(() => {});

  // Montar dados para envio
  const metadata = {
    name: file.name,
    mimeType: file.type,
    parents: ['1bIys1gHPhDJvRY-TJg1ClgIMJqON_dEm'] // ID da pasta no Drive
  };

  const formData = new FormData();
  formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  formData.append('file', file);

  try {
    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
      method: 'POST',
      headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
      body: formData
    });

    const result = await response.json();

    if (result.id) {
      msg.innerHTML = '✅ Imagem enviada! <a class="text-blue-600 underline" href="https://drive.google.com/file/d/' + result.id + '/view" target="_blank">Ver imagem</a>';
      form.reset();
    } else {
      msg.textContent = '❌ Falha ao enviar: ' + (result.error?.message || 'Erro desconhecido');
    }
  } catch (e) {
    msg.textContent = '❌ Erro na conexão com o Google Drive.';
  }

  msg.classList.remove('hidden');
});

  </script>
</body>
</html>
