<!DOCTYPE html>
<html lang="pt-BR">
<!-- =========================================================
     FORMULÁRIO “Gerar Orçamento – OD Drive”
     ---------------------------------------------------------
     Passo-a-passo ao clicar no botão Gerar Orçamento
       1. Google OAuth (caso não haja token válido em cache)
       2. Upload da imagem selecionada para 1 pasta específica
       3. Envio de TODOS os dados + link da imagem ao webhook
     ========================================================= -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerar Orçamento • OD Drive</title>

  <!-- Tailwind — utilizado apenas via CDN para fins de protótipo -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Identity + GAPI (obrigatórios para OAuth 2 + Drive) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"      async defer></script>

  <style>
    :root{ --od-primary:#0f766e; }
    .bg-primary{background-color:var(--od-primary)}
    .focus\:ring-primary:focus{
      --tw-ring-color:var(--od-primary);--tw-ring-opacity:.6}
  </style>
</head>

<body class="min-h-screen flex items-center justify-center bg-gray-100 px-2">
<!-- ======================= CONTAINER ======================= -->
<section class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 sm:p-8">
  <h1 class="text-2xl sm:text-3xl font-semibold text-center text-gray-800 mb-8">
    Gerar Orçamento&nbsp;– OD Drive
  </h1>

  <!-- ==================== FORM INÍCIO ===================== -->
  <form id="odForm" class="space-y-6">

    <!-- ---------- Grupo: dados principais ---------- -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <!-- Empresa -->
      <div class="sm:col-span-2">
        <label class="block text-sm mb-1" for="company_name">Empresa</label>
        <input id="company_name" name="company_name" required
               class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary">
      </div>
      <!-- Site -->
      <div>
        <label class="block text-sm mb-1" for="site_url">Site</label>
        <input id="site_url" name="site_url" type="url" required
               placeholder="https://exemplo.com"
               class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary">
      </div>
      <!-- Cidade -->
      <div>
        <label class="block text-sm mb-1" for="city">Cidade</label>
        <input id="city" name="city" required
               class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary">
      </div>
      <!-- Objetivo -->
      <div class="sm:col-span-2">
        <label class="block text-sm mb-1" for="objective">Objetivo</label>
        <input id="objective" name="objective" required
               class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary">
      </div>
      <!-- Upload -->
      <div class="sm:col-span-2">
        <label class="block text-sm mb-1" for="mockup_image">
          Imagem / Mockup (PNG ou JPG)
        </label>
        <input id="mockup_image" name="mockup_image" type="file"
               accept="image/png,image/jpeg" required
               class="w-full rounded-lg border-gray-300 bg-white focus:ring-2 focus:ring-primary">
      </div>
    </div>

    <!-- ---------- Grupo: números ---------- -->
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm mb-1" for="cars_qtd">Qtd.&nbsp;Carros</label>
        <input id="cars_qtd" name="cars_qtd" type="number" min="1" required
               class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary">
      </div>
      <div>
        <label class="block text-sm mb-1" for="discount">Desconto&nbsp;(R$)</label>
        <input id="discount" name="discount" type="number" step="0.01" value="0"
               class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-primary">
      </div>
    </div>

    <!-- ---------- Botão Submit ---------- -->
    <button type="submit"
            class="w-full py-3 bg-primary text-white font-semibold rounded-lg
                   hover:opacity-90 transition-all shadow-sm">
      Gerar Orçamento
    </button>

    <!-- Mensagem dinâmica -->
    <p id="msg" class="text-center text-sm mt-2 hidden"></p>
  </form>
  <!-- ==================== FORM FIM ===================== -->
</section>
<!-- ===================== CONTAINER FIM ================= -->

<!-- ==================================================================== -->
<script>
/* ╔═════════════════════ CONSTANTES DE CONFIG  ════════════════════════╗ */
const CLIENT_ID = '206253858878-rdmme43csja9vuicd6uh4so1cgfg3v0u.apps.googleusercontent.com';     // Google OAuth
const API_KEY = 'AIzaSyDSQt5SOwfXOKuMasPUShacyHmsjzObDnA';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';   // acesso pasta
const DRIVE_FOLDERID = '1bIys1gHPhDJvRY-TJg1ClgIMJqON_dEm';                          // ID da pasta
const WEBHOOK_URL    = 'https://hook.us2.make.com/ssddbgjp5jqdwpdcmmbrx14d2chwmxxa';         // Webhook Make
/* ╚═══════════════════════════════════════════════════════════════════╝ */


 
/* --------- Referências DOM --------- */
const form       = document.getElementById('odForm');
const msg        = document.getElementById('msg');
const inputFile  = document.getElementById('mockup_image');

/* --------- Variáveis de token --------- */
let accessToken  = '';
let tokenClient;   // ficará disponível após gapi + Identity

/* ====================================================================
   UTILIDADES DE MENSAGEM (verde = OK | vermelho = erro)
   ==================================================================== */
function showMsg(text, ok=true){
  msg.textContent = text;
  msg.className   = `text-center text-sm mt-2 ${ok? 'text-primary':'text-red-600'}`;
  msg.classList.remove('hidden');
}

/* ====================================================================
   1)  AUTENTICAÇÃO  (carrega GAPI → obtém / renova access_token)
   ==================================================================== */
function ensureGoogleToken(){
  return new Promise((resolve,reject)=>{

    /* se já temos token válido em cache, usa direto */
    const exp = Number(localStorage.getItem('token_exp'))||0;
    if(accessToken && Date.now() < exp){ return resolve(); }

    /* carrega GAPI + inicia client */
    gapi.load('client', async ()=>{
      await gapi.client.init({ apiKey: API_KEY });

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES,
        callback: (resp)=>{
          if(resp && resp.access_token){
            accessToken = resp.access_token;
            const e = Date.now()+((resp.expires_in||3600)-300)*1e3;
            localStorage.setItem('token_exp', e);
            resolve();
          }else{
            reject('Falha ao obter token');
          }
        }
      });

      tokenClient.requestAccessToken({ prompt:'consent' });
    });
  });
}

/* ====================================================================
   2)  UPLOAD PARA O DRIVE  (mulitpart/form-data)
   ==================================================================== */
async function uploadFileToDrive(file){
  const metadata = {
    name: file.name,
    mimeType: file.type,
    parents:[DRIVE_FOLDERID]
  };

  const body = new FormData();
  body.append('metadata', new Blob([JSON.stringify(metadata)],{type:'application/json'}));
  body.append('file', file);

  const res = await fetch(
    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink',
    { method:'POST', headers:{ Authorization:'Bearer '+accessToken }, body });

  if(!res.ok) throw new Error('Google Drive retornou '+res.status);
  return res.json();                // { id, webViewLink }
}

/* ====================================================================
   3)  ENVIA OS DADOS (JSON) PARA O WEBHOOK DO MAKE
   ==================================================================== */
async function sendPayloadToMake(dataObj){
  await fetch(WEBHOOK_URL,{
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body:JSON.stringify(dataObj)
  });
}

/* ====================================================================
   LISTENER DE SUBMISSÃO
   ==================================================================== */
form.addEventListener('submit', async ev=>{
  ev.preventDefault(); msg.classList.add('hidden');

  /* validação do arquivo */
  const file = inputFile.files[0];
  if(!file || !['image/png','image/jpeg'].includes(file.type)){
    showMsg('Selecione uma imagem PNG ou JPG', false); return;
  }

  try{
    /* 1. OAuth (se preciso) */
    await ensureGoogleToken();

    /* 2. Upload para Drive */
    const driveInfo = await uploadFileToDrive(file);

    /* 3. Monta payload e dispara Webhook */
    const formDataObj = Object.fromEntries(new FormData(form).entries());
    formDataObj.mockup_drive_link = driveInfo.webViewLink;

    await sendPayloadToMake(formDataObj);

    showMsg('✅ Orçamento enviado com sucesso!'); form.reset();

  }catch(err){
    console.error(err);
    showMsg('Erro: '+err.message||err, false);
  }
});
</script>
</body>
</html>
